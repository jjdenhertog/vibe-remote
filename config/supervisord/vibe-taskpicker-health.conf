# Health check configuration for vibe-taskpicker
# This configuration includes health monitoring and automatic recovery

[program:vibe-taskpicker-health]
# Main command with health check wrapper
command=%(ENV_PROJECT_ROOT)s/scripts/taskpicker-health-wrapper.sh

# Working directory
directory=%(ENV_PROJECT_ROOT)s

# Process management with enhanced error recovery
autostart=true
autorestart=unexpected         ; Restart on unexpected exit codes
startretries=10                ; More retries for resilience
startsecs=5                     ; Must stay up for 5 seconds
exitcodes=0                     ; Only 0 is considered success
stopsignal=TERM
stopwaitsecs=30

# Enhanced logging with debug information
stderr_logfile=/var/log/supervisor/vibe-taskpicker-health.err.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=10
stderr_capture_maxbytes=2MB
stderr_events_enabled=true
stdout_logfile=/var/log/supervisor/vibe-taskpicker-health.out.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=10
stdout_capture_maxbytes=2MB

# Environment with health check settings
environment=
    NODE_ENV="production",
    PROJECT_ROOT="%(ENV_PROJECT_ROOT)s",
    CLAUDE_COMMAND="claude",
    VIBE_API_URL="http://localhost:3001",
    TASK_CHECK_INTERVAL="300",
    LOG_LEVEL="debug",
    ANTHROPIC_API_KEY="%(ENV_ANTHROPIC_API_KEY)s",
    CLAUDE_API_KEY="%(ENV_CLAUDE_API_KEY)s",
    VIBE_PROJECT_ID="%(ENV_VIBE_PROJECT_ID)s",
    HEALTH_CHECK_ENABLED="true",
    HEALTH_CHECK_INTERVAL="60",
    MAX_CONSECUTIVE_FAILURES="3",
    FAILURE_NOTIFICATION_EMAIL="%(ENV_ADMIN_EMAIL)s"

# User and priority
user=root
priority=997

# Process control
process_name=%(program_name)s
numprocs=1
redirect_stderr=false
killasgroup=true
stopasgroup=true

# Event listeners for monitoring
[eventlistener:vibe-taskpicker-monitor]
command=%(ENV_PROJECT_ROOT)s/scripts/taskpicker-monitor.py
events=PROCESS_STATE_FATAL,PROCESS_STATE_EXITED,PROCESS_STATE_STOPPED
buffer_size=10
stdout_logfile=/var/log/supervisor/vibe-taskpicker-monitor.log
stderr_logfile=/var/log/supervisor/vibe-taskpicker-monitor.err